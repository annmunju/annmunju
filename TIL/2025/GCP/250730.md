
### Building a Data Warehouse

> 데이터 웨어하우스 빌드하기

1. 데이터 웨어하우스 구성 요소
    - 데이터의 스키마를 알아야 사용할 수 있음
    - 형식을 표준화하고 쿼리에 사용하기에 유의미한 쿼리 결과를 도출. 일관성있고 깨끗한 데이터 보장.
    - 빠르게 쿼리가 이뤄지게 하는 것이 중요
    - 모던 데이터 웨어하우스란?
        - 기가바이트~페타바이트 확장 가능한 단일 데이터베이스
        - 서버리스, no-ops
        - 풍부한 시각화, BI 도구
        - 최신 상태로 유지된 데이터
        - 머신러닝 기능 (데이터를 외부로 옮기지 않고도 내부에서 실행)
        - 보안과 공동 작업 공유

2. BigQuery 소개
    - 위에 있는 모던 데이터 웨어하우스 특징을 다 가지고 있음
    - 인덱스 사용 안함. 열 지향 테이블 (원하는 필드 위주의 읽기 최적화)
    - 스토리지와 분석 엔진(컴퓨팅) 분리되어있고 둘은 초고속 통신을 지원함
    - 필터 먼저 동작하고 -> 계산하는거 여러 워커로 분산 실행 -> 합치기는 이후에 실행 등 쪼개서 수행함.

3. BigQuery 시작하기
    1) 데이터 테이블(데이터 세트) 구성: 프로젝트 - 데이터 세트 - 테이블 과 같은 범위를 사용하면 정보를 논리적으로 구성할 수 있음.
    2) 실행 로직 : QueryJob이 빅쿼리에 제출 -> 스토리지 서비스와 쿼리 서비스가 연결되어 윈하는 작업 수행. 동일한 쿼리 수행시 캐시 사용
    3) 쿼리 검사기와 가격 계산기 제공 : 쿼리비용과 스토리지비용 별도 부과. 데이터 세트는 프로젝트 소속이고 프로젝트 단위로 스토리지 비용 청구. 쿼리 요금은 사용자 프로젝트에 청구.
    4) 쿼리 실행에 대한 액세스 제어: 테이블/뷰, 열 수준에서 권한 제어 가능. 읽기 권한 / 쿼리 작업 제출 권한 등
    5) 리전 / 멀티리전 가능
    6) 암호화 키 설정 가능 (CMEK)
    7) 로그는 변경할 수 없고 cloud 운영으로 내보낼 수 있음
    8) 데이터 세트에 대한 보기 권한 부여 == 승인된 뷰 : 기본 소스 데이터에 대한 액세스 권한 없이도 쿼리 결과 공유 가능
    9) 데이터 마스킹 : 규칙을 정하고 정책 태그와 사용자/그룹에 할당하면 콘텐츠를 난독화/무효화 할 수 있음.
    10) 구체화된 뷰: 쿼리 결과 주기적으로 캐싱. 미리 계산된 결과 활용. 공통되고 반복되는 경우 주로 사용

4. BigQuery로 데이터 로드하기
    - 제공 포맷 : csv, json, avro, datastore_backup, parquet, orc 
    - 일일 한도가 있음
    - Json 형식은 구분자가 줄바꿈인 데이터만 가져옴
    - Firestore와 Datastore 내보내기 파일로 직접 가져올 수 있음
    - API 사용 : 주로 Dataproc 또는 Dataflow에서 사용
    - Cloud Storage로 복사해서 이걸 bq load로 전달할 수 있음
    - 백필 : 누락된 과거 데이터를 추가해 데이터 세트를 공백 없이 완성하고 모든 분석 프로세스가 예상대로 작동하도록 하는 것
    - BigQuery Data Transfer Service : 전송 반복 예약. 
    - 7일치의 쿼리 내용 보관. 특정 시점 스냅샷 쿼리 가능. 테이블 복구 가능
    - 간단한 Transform 수행 가능. UDF 작성 가능 (JS 지원)

5. 데이터 웨어하우스 스키마 
    - 데이터 정규화
    - 중첩/반복 필드는 미리 반영해서 효율적인 검색 지원

6. 중첩, 반복 필드에 대한 BigQuery 지원
    - 관계형 DB는 조인 연산에 대한 비용이 듦 / 반대로 거대한 테이블 형태(NoSQL)인 경우에는 데이터가 반복 저장됨
    - 중첩되고 반복되는 데이터 필드는 하나의 행을 가지고, 세분화 된 값들은 더 많은 값들을 가질 수 있도록 함. (피벗 테이블 처럼 표기함)
    - 스키마에서 구조체는 record 타입으로 표기하고, 점(.)이 포함되면 해당 구조체의 하위 항목이다.

![](src/스크린샷 2025-07-30 102255.png)

- [중첩 및 반복 열이 있는 BigQuery에서 비트코인 데이터 세트 쿼리](https://github.com/GoogleCloudPlatform/training-data-analyst/blob/master/courses/data-engineering/demos/nested.md)
    - from 절에서 "," 콤마는 암시적 교차 조인(cross join)을 의미

- 테이블이 10gb 미만인 경우 join 수행 어렵지 않으나, 이보다 크면 차라리 비정규화해서 사용하는게 낫다

7. 파티셔닝과 클러스터링으로 최적화하기
    - 테이블 최적화 방법 : 파티셔닝과 클러스터링
    - 파티셔닝 : 데이터 읽기의 양과 비용을 줄이기
        - 파티션 지정시 빅쿼리는 내부 스토리지를 변경하여 지정된 필드로 나눠 저장되도록 함
        - 지정된 파티션만 읽으니까 시간 절약됨
        - 전역 데이터 파티셔닝 설정시에 메타데이터 양은 늘지만 **비용 추산이 용이** (최종 쿼리 비용 상한가 계산이 용이)
    - 클러스터링 : 파티션 내부 또는 일반 테이블에서 지정된 컬럼 기준으로 데이터를 정렬/그룹화해 저장
        - 불필요한 스캔 하지 않도록 **정렬된 블록을 사용함**
        - 부분 정렬 테이블에서는 클러슽터링이 부적절할 수 있음 (더많은 블록 탐색)
        - 빅쿼리는 주기적으로 자동 재클러스터링 수행. 